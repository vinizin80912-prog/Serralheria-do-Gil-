<!doctype html>
<html lang="pt-br">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>Serralheria do Gil</title>

<style>
:root{
 --bg:#050807;
 --card:#0c1411;
 --b:#1a2a22;
 --txt:#eaf6ee;
 --mut:#9fb3a7;
 --g:#4cff88;
 --r:#ff5a6b;
}

*{box-sizing:border-box}
body{
 margin:0;
 font-family:system-ui;
 background:var(--bg);
 color:var(--txt);
 overflow-x:hidden;
}

canvas#fx{
 position:fixed;
 inset:0;
 z-index:0;
}

.wrap{
 position:relative;
 z-index:1;
 max-width:900px;
 margin:auto;
 padding:18px 14px 100px;
}

/* CARD */
.card{
 background:linear-gradient(180deg,#0e1814,#070c0a);
 border:1px solid var(--b);
 border-radius:18px;
 padding:16px;
 box-shadow:0 15px 50px rgba(0,0,0,.6);
}

/* HOME */
#home{
 display:flex;
 min-height:90vh;
 align-items:center;
 justify-content:center;
}

.homeBox{
 text-align:center;
 max-width:520px;
}

.homeBox h1{
 font-size:34px;
 margin:0 0 10px;
}

.homeBox p{
 color:var(--mut);
 margin:0 0 24px;
}

.btn{
 border:0;
 padding:14px 28px;
 border-radius:16px;
 font-weight:900;
 background:#fff;
 color:#000;
 font-size:16px;
 cursor:pointer;
}

.btn:active{transform:scale(.95)}

.hidden{display:none}
</style>
</head>

<body>

<canvas id="fx"></canvas>

<div class="wrap">

<!-- HOME -->
<section id="home">
 <div class="card homeBox">
  <h1>Serralheria do Gil</h1>
  <p>Gostaria de fazer dinheiro?<br>Clique no bot√£o abaixo.</p>
  <button class="btn" onclick="startApp()">Iniciar</button>
 </div>
</section>

<!-- APP -->
<section id="app" class="hidden">
  <style>
/* TOP */
.top{
 display:flex;gap:12px;align-items:center;justify-content:space-between;
 margin:0 0 12px;
}
.brand{
 display:flex;gap:10px;align-items:center;
}
.logo{
 width:44px;height:44px;border-radius:14px;
 display:grid;place-items:center;
 background:linear-gradient(145deg,#0f1a13,#08100b);
 border:1px solid var(--b);
}
.title{font-weight:950;font-size:18px;line-height:1.1}
.subtitle{color:var(--mut);font-size:12px;margin-top:2px}
.pill{
 padding:8px 10px;border-radius:999px;
 border:1px solid var(--b);
 background:rgba(10,18,14,.7);
 color:var(--mut);font-size:12px;
}

/* GRID */
.row{display:flex;gap:10px;flex-wrap:wrap}
.kpi{flex:1;min-width:230px;position:relative;overflow:hidden}
.kpi .t{color:var(--mut);font-size:12px}
.kpi .v{font-size:30px;font-weight:950;margin-top:4px}
.kpi .s{color:var(--mut);font-size:12px;margin-top:6px}
.sep{height:1px;background:#132019;margin:12px 0}

/* TABS */
.tab{display:none;animation:pop .18s ease both}
.tab.on{display:block}
@keyframes pop{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}

/* INPUTS */
.in{
 width:100%;
 padding:12px 12px;
 border-radius:14px;
 border:1px solid var(--b);
 background:rgba(10,18,14,.7);
 color:var(--txt);
 outline:none;
}
.in::placeholder{color:#6e8578}
.grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
@media(max-width:640px){.grid2{grid-template-columns:1fr}}

/* NAV */
.nav{
 position:fixed;left:0;right:0;bottom:0;z-index:2;
 padding:10px 12px;
 background:linear-gradient(180deg,transparent,rgba(0,0,0,.55) 20%,rgba(0,0,0,.88));
 backdrop-filter:blur(10px);
}
.bar{
 max-width:900px;margin:auto;
 display:grid;grid-template-columns:repeat(5,1fr);gap:10px;
}
.nb{
 padding:10px 8px;border-radius:16px;
 border:1px solid var(--b);
 background:rgba(10,18,14,.75);
 color:#b8c7bb;font-weight:900;
 display:flex;gap:8px;align-items:center;justify-content:center;
 transition:.18s;
}
.nb.on{background:#fff;color:#000;border-color:#fff}
.nb:active{transform:scale(.98)}

/* CHART */
#chart{
 width:100%;height:260px;
 border-radius:18px;
 border:1px solid var(--b);
 background:linear-gradient(180deg,#08110d,#050807);
}
.small{color:var(--mut);font-size:12px;line-height:1.35}
.pos{color:var(--g);font-weight:950}
.neg{color:var(--r);font-weight:950}
</style>

<div class="top">
  <div class="brand">
    <div class="logo">üîß</div>
    <div>
      <div class="title">Serralheria do Gil</div>
      <div class="subtitle">Controle ‚Ä¢ Agenda ‚Ä¢ Or√ßamentos ‚Ä¢ Clientes</div>
    </div>
  </div>
  <div class="pill" id="pillMes">----</div>
</div>

<!-- DASH -->
<section id="tabDash" class="tab on">
  <div class="row">
    <div class="card kpi">
      <div class="t">Saldo hoje</div>
      <div class="v" id="kHoje">R$ 0,00</div>
      <div class="s" id="kHoje2">GN: R$ 0,00 ‚Ä¢ SD: R$ 0,00</div>
    </div>
    <div class="card kpi">
      <div class="t">Saldo do m√™s</div>
      <div class="v" id="kMes">R$ 0,00</div>
      <div class="s" id="kMes2">GN: R$ 0,00 ‚Ä¢ SD: R$ 0,00</div>
    </div>
  </div>

  <div class="card" style="margin-top:10px">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:10px">
      <div>
        <div style="font-weight:950">GN vs SD (m√™s)</div>
        <div class="small">Gr√°fico animado crescendo (sem donut feio).</div>
      </div>
      <div class="pill" id="labMes">----</div>
    </div>
    <div style="margin-top:10px"><canvas id="chart"></canvas></div>
    <div class="small" id="chartTip" style="margin-top:8px;min-height:16px"></div>
  </div>

  <div class="row" style="margin-top:10px">
    <div class="card kpi">
      <div class="t">Previs√£o (offline)</div>
      <div class="v" id="prev">R$ 0,00</div>
      <div class="s">M√©dia m√≥vel + tend√™ncia simples.</div>
    </div>
    <div class="card kpi">
      <div class="t">Top clientes (m√™s)</div>
      <div class="v" style="font-size:16px;margin-top:10px" id="topCli">Sem dados</div>
      <div class="s">Dica: preencha ‚ÄúCliente‚Äù nos lan√ßamentos.</div>
    </div>
  </div>
</section>
<!-- MOVIMENTOS -->
<section id="tabMov" class="tab">
  <div class="card">
    <div class="grid2">
      <div>
        <div class="small">Tipo</div>
        <div class="row" style="margin-top:6px">
          <button class="btn" id="bGN" onclick="setTipo('GN')">GN (Ganhos)</button>
          <button class="btn" id="bSD" onclick="setTipo('SD')" style="background:transparent;color:var(--txt);border:1px solid var(--b)">SD (Sa√≠das)</button>
        </div>
      </div>
      <div>
        <div class="small">Data</div>
        <input class="in" id="mData" type="date">
      </div>
    </div>

    <div class="grid2" style="margin-top:10px">
      <div>
        <div class="small">Valor (R$)</div>
        <input class="in" id="mVal" type="number" step="0.01" placeholder="Ex: 250">
      </div>
      <div>
        <div class="small">Cliente (opcional)</div>
        <input class="in" id="mCli" placeholder="Ex: Jo√£o / Obra X">
      </div>
    </div>

    <div class="grid2" style="margin-top:10px">
      <div>
        <div class="small">Categoria (opcional)</div>
        <input class="in" id="mCat" placeholder="Ex: Port√£o / Solda">
      </div>
      <div>
        <div class="small">Obs (opcional)</div>
        <input class="in" id="mObs" placeholder="Ex: sinal, restante‚Ä¶">
      </div>
    </div>

    <div class="row" style="margin-top:12px">
      <button class="btn" onclick="salvarMov()">Salvar</button>
      <button class="btn" style="background:transparent;color:var(--txt);border:1px solid var(--b)" onclick="limparMov()">Limpar</button>
      <button class="btn" style="background:transparent;color:var(--txt);border:1px solid var(--b)" onclick="go('Dash')">Ver Dash</button>
    </div>

    <div class="sep"></div>
    <div class="small">Atalhos:</div>
    <div class="row" style="margin-top:8px">
      <button class="btn" style="background:transparent;color:var(--txt);border:1px solid var(--b)" onclick="addAtalho(50)">+50</button>
      <button class="btn" style="background:transparent;color:var(--txt);border:1px solid var(--b)" onclick="addAtalho(100)">+100</button>
      <button class="btn" style="background:transparent;color:var(--txt);border:1px solid var(--b)" onclick="addAtalho(200)">+200</button>
      <button class="btn" style="background:transparent;color:var(--txt);border:1px solid var(--b)" onclick="addAtalho(500)">+500</button>
    </div>
  </div>

  <div class="card" style="margin-top:10px">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:10px">
      <div>
        <div style="font-weight:950">Hist√≥rico (m√™s)</div>
        <div class="small">Aparece assim que salvar. Tem copiar e remover.</div>
      </div>
      <div class="pill" id="movMes">----</div>
    </div>
    <div id="movList" style="margin-top:8px"></div>
  </div>
</section>
<!-- AGENDA -->
<section id="tabAg" class="tab">
  <div class="card">
    <div class="grid2">
      <div>
        <div class="small">Cliente</div>
        <input class="in" id="aCli" placeholder="Nome do cliente">
      </div>
      <div>
        <div class="small">Telefone (opcional)</div>
        <input class="in" id="aTel" inputmode="tel" placeholder="(41) 9....">
      </div>
    </div>

    <div class="grid2" style="margin-top:10px">
      <div>
        <div class="small">Data</div>
        <input class="in" id="aData" type="date">
      </div>
      <div>
        <div class="small">Hora</div>
        <input class="in" id="aHora" type="time">
      </div>
    </div>

    <div style="margin-top:10px">
      <div class="small">Descri√ß√£o do servi√ßo</div>
      <input class="in" id="aDesc" placeholder="Ex: Instalar port√£o, ajuste, solda...">
    </div>

    <div class="row" style="margin-top:12px">
      <button class="btn" onclick="salvarAg()">Salvar servi√ßo</button>
      <button class="btn" style="background:transparent;color:var(--txt);border:1px solid var(--b)" onclick="limparAg()">Limpar</button>
      <button class="btn" style="background:transparent;color:var(--txt);border:1px solid var(--b)" onclick="notiPerm()">Notifica√ß√£o</button>
    </div>

    <div class="small" style="margin-top:10px">
      Lembrete 1h antes: <span style="color:var(--y);font-weight:900">s√≥ funciona com a p√°gina aberta</span>.
    </div>
  </div>

  <div class="card" style="margin-top:10px">
    <div style="font-weight:950">Pr√≥ximos servi√ßos</div>
    <div id="agList" style="margin-top:8px"></div>
  </div>
</section>
<!-- CLIENTES -->
<section id="tabCli" class="tab">
  <div class="card">
    <div class="grid2">
      <div>
        <div class="small">Nome</div>
        <input class="in" id="cNome" placeholder="Cliente">
      </div>
      <div>
        <div class="small">Telefone</div>
        <input class="in" id="cTel" inputmode="tel" placeholder="(41) 9....">
      </div>
    </div>

    <div style="margin-top:10px">
      <div class="small">Endere√ßo (opcional)</div>
      <input class="in" id="cEnd" placeholder="Rua, bairro...">
    </div>

    <div class="row" style="margin-top:12px">
      <button class="btn" onclick="salvarCliente()">Salvar</button>
      <button class="btn" style="background:transparent;color:var(--txt);border:1px solid var(--b)" onclick="limparCliente()">Limpar</button>
    </div>
  </div>

  <div class="card" style="margin-top:10px">
    <div style="font-weight:950">Lista de clientes</div>
    <div id="cliList" style="margin-top:8px"></div>
  </div>
</section>

<!-- OR√áAMENTOS -->
<section id="tabOrc" class="tab">
  <div class="card">
    <div class="grid2">
      <div><div class="small">Cliente</div><input class="in" id="oCli" placeholder="Nome do cliente"></div>
      <div><div class="small">Telefone (opcional)</div><input class="in" id="oTel" inputmode="tel" placeholder="(41) 9...."></div>
    </div>

    <div class="grid2" style="margin-top:10px">
      <div><div class="small">Pre√ßo (R$)</div><input class="in" id="oVal" type="number" step="0.01" placeholder="Ex: 1200"></div>
      <div><div class="small">Prazo</div><input class="in" id="oPrazo" placeholder="Ex: 3 dias / 1 semana"></div>
    </div>

    <div style="margin-top:10px">
      <div class="small">Descri√ß√£o</div>
      <input class="in" id="oDesc" placeholder="Ex: Port√£o + pintura...">
    </div>

    <div class="row" style="margin-top:12px">
      <button class="btn" onclick="salvarOrc()">Salvar</button>
      <button class="btn" style="background:transparent;color:var(--txt);border:1px solid var(--b)" onclick="limparOrc()">Limpar</button>
      <button class="btn" style="background:transparent;color:var(--txt);border:1px solid var(--b)" onclick="zapOrc()">WhatsApp</button>
    </div>

    <div class="small" style="margin-top:10px">O WhatsApp abre com a mensagem pronta.</div>
  </div>

  <div class="card" style="margin-top:10px">
    <div style="font-weight:950">Or√ßamentos</div>
    <div id="orcList" style="margin-top:8px"></div>
  </div>
</section>
<div class="nav">
  <div class="bar">
    <div class="nb on" id="bDash" onclick="go('Dash')"><i>üìä</i>Dash</div>
    <div class="nb" id="bMov" onclick="go('Mov')"><i>üí∞</i>Mov</div>
    <div class="nb" id="bAg" onclick="go('Ag')"><i>üìÖ</i>Agenda</div>
    <div class="nb" id="bCli" onclick="go('Cli')"><i>üë§</i>Clientes</div>
    <div class="nb" id="bOrc" onclick="go('Orc')"><i>üßæ</i>Or√ß</div>
  </div>
</div>

</section><!-- /app -->
</div><!-- /wrap -->

<script>
/* ====== APP CORE ====== */
const KEY="gil_app_v6";
const $=id=>document.getElementById(id);
const brl=n=>Number(n||0).toLocaleString("pt-BR",{style:"currency",currency:"BRL"});
const iso=()=>new Date().toISOString().slice(0,10);
const ym=d=>(d||new Date()).toISOString().slice(0,7);
const digits=s=>(s||"").replace(/\D/g,"");
const vib=()=>navigator.vibrate&&navigator.vibrate(12);

const load=()=>{try{
  return JSON.parse(localStorage.getItem(KEY)||"null")||{mov:[],ag:[],cli:[],orc:[],tipo:"GN"};
}catch{return {mov:[],ag:[],cli:[],orc:[],tipo:"GN"}}};

let DB=load(), CUR=ym();

function save(){localStorage.setItem(KEY,JSON.stringify(DB));}

function startApp(){
  $("home").classList.add("hidden");
  $("app").classList.remove("hidden");
  $("mData").value=iso(); $("aData").value=iso(); $("aHora").value="08:00";
  setTipo(DB.tipo||"GN");
  go("Dash");
  fxResize(); spawn(); requestAnimationFrame(fxTick);
  render(); checkAgendaNotifySoon();
}

function go(name){
  ["Dash","Mov","Ag","Cli","Orc"].forEach(n=>{
    $("tab"+n).classList.remove("on");
    $("b"+n).classList.remove("on");
  });
  $("tab"+name).classList.add("on");
  $("b"+name).classList.add("on");
  vib(); render();
}
</script>
<script>
/* ====== MOVIMENTOS ====== */
function setTipo(t){
  DB.tipo=t; save();
  const gn=$("bGN"), sd=$("bSD");
  if(t==="GN"){
    gn.style.background="#fff"; gn.style.color="#000"; gn.style.border="0";
    sd.style.background="transparent"; sd.style.color="var(--txt)"; sd.style.border="1px solid var(--b)";
  }else{
    sd.style.background="#fff"; sd.style.color="#000"; sd.style.border="0";
    gn.style.background="transparent"; gn.style.color="var(--txt)"; gn.style.border="1px solid var(--b)";
  }
}
function addAtalho(v){$("mVal").value=(+($("mVal").value||0)+v).toFixed(2); vib();}
function limparMov(){["mVal","mCli","mCat","mObs"].forEach(x=>$(x).value=""); $("mData").value=iso();}
function salvarMov(){
  const data=$("mData").value||iso(), val=+($("mVal").value||0);
  if(!val||val<=0) return alert("Valor inv√°lido");
  DB.mov.unshift({
    id:Date.now()+"", m:data.slice(0,7), data, tipo:DB.tipo, val,
    cli:($("mCli").value||"").trim(), cat:($("mCat").value||"").trim(), obs:($("mObs").value||"").trim()
  });
  save(); limparMov(); CUR=data.slice(0,7); render(); go("Mov");
}
function delMov(id){
  if(!confirm("Remover lan√ßamento?"))return;
  DB.mov=DB.mov.filter(x=>x.id!==id); save(); render();
}

/* ====== CLIENTES ====== */
function limparCliente(){["cNome","cTel","cEnd"].forEach(x=>$(x).value="");}
function salvarCliente(){
  const nome=($("cNome").value||"").trim(); if(!nome) return alert("Nome obrigat√≥rio");
  const tel=digits($("cTel").value), end=($("cEnd").value||"").trim();
  const ex=DB.cli.find(c=>c.nome.toLowerCase()===nome.toLowerCase());
  if(ex){ex.tel=tel; ex.end=end;}
  else DB.cli.unshift({id:Date.now()+"",nome,tel,end});
  save(); limparCliente(); render(); go("Cli");
}
function delCli(id){
  if(!confirm("Remover cliente?"))return;
  DB.cli=DB.cli.filter(x=>x.id!==id); save(); render();
}
</script>
<script>
/* ====== AGENDA ====== */
function limparAg(){["aCli","aTel","aDesc"].forEach(x=>$(x).value=""); $("aData").value=iso(); $("aHora").value="08:00";}
function salvarAg(){
  const cli=($("aCli").value||"").trim(), desc=($("aDesc").value||"").trim();
  const data=$("aData").value||iso(), hora=$("aHora").value||"08:00";
  if(!cli||!desc) return alert("Cliente e descri√ß√£o obrigat√≥rios");
  DB.ag.unshift({id:Date.now()+"",cli,desc,data,hora,tel:digits($("aTel").value)});
  save(); limparAg(); render(); checkAgendaNotifySoon(); go("Ag");
}
function delAg(id){
  if(!confirm("Remover servi√ßo?"))return;
  DB.ag=DB.ag.filter(x=>x.id!==id); save(); render();
}
async function notiPerm(){
  if(!("Notification" in window)) return alert("Sem suporte a notifica√ß√µes.");
  const p=await Notification.requestPermission();
  alert(p==="granted"?"Notifica√ß√µes ativadas ‚úÖ":"Permiss√£o negada.");
}
function checkAgendaNotifySoon(){setTimeout(checkAgendaNotify,900);}
function checkAgendaNotify(){
  if(!("Notification" in window) || Notification.permission!=="granted") return;
  const now=Date.now();
  DB.ag.forEach(s=>{
    if(s.done) return;
    const dt=new Date(`${s.data}T${s.hora}:00`).getTime();
    const left=dt-now;
    if(left<=3600000 && left>0){
      s.done=1; save();
      new Notification("Serralheria do Gil",{body:`Servi√ßo: ${s.cli}\n${s.desc}\nFalta: ~${Math.ceil(left/60000)} min`});
    }
  });
}

/* ====== OR√áAMENTOS ====== */
function limparOrc(){["oCli","oTel","oVal","oPrazo","oDesc"].forEach(x=>$(x).value="");}
function salvarOrc(){
  const cli=($("oCli").value||"").trim(), val=+($("oVal").value||0), desc=($("oDesc").value||"").trim();
  if(!cli||!val||val<=0||!desc) return alert("Cliente, valor e descri√ß√£o obrigat√≥rios");
  DB.orc.unshift({id:Date.now()+"",cli,tel:digits($("oTel").value),val,prazo:($("oPrazo").value||"").trim(),desc,at:Date.now()});
  save(); limparOrc(); render(); go("Orc");
}
function delOrc(id){
  if(!confirm("Remover or√ßamento?"))return;
  DB.orc=DB.orc.filter(x=>x.id!==id); save(); render();
}
function openZap(tel,msg){
  const u=tel?`https://wa.me/${tel}?text=${encodeURIComponent(msg)}`:`https://wa.me/?text=${encodeURIComponent(msg)}`;
  window.open(u,"_blank");
}
function zapOrc(){
  const cli=($("oCli").value||"").trim(), val=+($("oVal").value||0), prazo=($("oPrazo").value||"").trim(), desc=($("oDesc").value||"").trim();
  if(!cli||!val||!desc) return alert("Preencha cliente, valor e descri√ß√£o.");
  const tel=digits($("oTel").value)||"";
  const msg=`*Or√ßamento - Serralheria do Gil*\nCliente: ${cli}\nServi√ßo: ${desc}\nValor: ${brl(val)}\nPrazo: ${prazo||"a combinar"}\n\nSe aprovar, me confirma por aqui.`;
  openZap(tel,msg);
}
</script>
<script>
/* ====== GR√ÅFICO (ANIMADO) ====== */
let chartAnim=0,lastSig="";
const easeOut=t=>1-Math.pow(1-t,3);

function fitCanvas(c){
  const dpr=Math.max(1,devicePixelRatio||1);
  const r=c.getBoundingClientRect();
  const w=Math.round(r.width*dpr), h=Math.round(r.height*dpr);
  if(c.width!==w||c.height!==h){c.width=w;c.height=h;}
  return {w,h};
}
function roundRect(ctx,x,y,w,h,r){
  r=Math.min(r,w/2,h/2); ctx.beginPath();
  ctx.moveTo(x+r,y); ctx.arcTo(x+w,y,x+w,y+h,r);
  ctx.arcTo(x+w,y+h,x,y+h,r); ctx.arcTo(x,y+h,x,y,r);
  ctx.arcTo(x,y,x+w,y,r); ctx.closePath();
}
function drawBars(gn,sd,prog){
  const c=$("chart"),ctx=c.getContext("2d");
  const {w,h}=fitCanvas(c);
  ctx.clearRect(0,0,w,h);

  const bg=ctx.createLinearGradient(0,0,0,h);
  bg.addColorStop(0,"#0a120e"); bg.addColorStop(1,"#050807");
  ctx.fillStyle=bg; ctx.fillRect(0,0,w,h);

  const base=h-55, pad=70, max=Math.max(gn,sd,1);
  const bw=Math.min(170,Math.max(120,w*0.18));
  const gap=Math.min(90,Math.max(60,w*0.08));
  const x1=w/2-bw-gap/2, x2=w/2+gap/2;

  const H=v=>((v/max)*(h-pad))*prog;

  ctx.strokeStyle="#1a2a22"; ctx.lineWidth=2;
  ctx.beginPath(); ctx.moveTo(40,base); ctx.lineTo(w-40,base); ctx.stroke();

  const gh=H(gn); ctx.fillStyle="rgba(76,255,136,.95)"; roundRect(ctx,x1,base-gh,bw,gh,18); ctx.fill();
  const sh=H(sd); ctx.fillStyle="rgba(255,90,107,.92)"; roundRect(ctx,x2,base-sh,bw,sh,18); ctx.fill();

  ctx.fillStyle="#eaf6ee"; ctx.textAlign="center";
  ctx.font=Math.max(28,Math.round(w*0.03))+"px system-ui";
  ctx.fillText("GN",x1+bw/2,base+34); ctx.fillText("SD",x2+bw/2,base+34);

  ctx.font=Math.max(22,Math.round(w*0.025))+"px system-ui";
  ctx.fillText(brl(gn),x1+bw/2,base-gh-14);
  ctx.fillText(brl(sd),x2+bw/2,base-sh-14);

  $("chartTip").innerHTML=`GN: <span class="pos">${brl(gn)}</span> ‚Ä¢ SD: <span class="neg">${brl(sd)}</span> ‚Ä¢ Saldo: <b>${brl(gn-sd)}</b>`;
}
function animateChart(gn,sd){
  const sig=gn+"|"+sd+"|"+CUR;
  if(sig===lastSig && chartAnim>=1) return;
  lastSig=sig; chartAnim=0;
  const tick=()=>{
    chartAnim=Math.min(1,chartAnim+0.06);
    drawBars(gn,sd,easeOut(chartAnim));
    if(chartAnim<1) requestAnimationFrame(tick);
  };
  requestAnimationFrame(tick);
}

/* ====== FECHAMENTO ====== */
function fechamento(){
  const mov=DB.mov.filter(x=>x.m===CUR);
  const gn=mov.filter(x=>x.tipo==="GN").reduce((a,b)=>a+b.val,0);
  const sd=mov.filter(x=>x.tipo==="SD").reduce((a,b)=>a+b.val,0);
  alert(`Fechamento ${CUR}\nGN: ${brl(gn)}\nSD: ${brl(sd)}\nSaldo: ${brl(gn-sd)}`);
}
</script>
<script>
/* ====== RENDER ====== */
function render(){
  if(!$("pillMes")) return;
  $("pillMes").textContent=CUR;
  $("labMes").textContent=CUR;
  $("movMes").textContent=CUR;

  const today=iso();
  const movT=DB.mov.filter(x=>x.data===today);
  const gnT=movT.filter(x=>x.tipo==="GN").reduce((a,b)=>a+b.val,0);
  const sdT=movT.filter(x=>x.tipo==="SD").reduce((a,b)=>a+b.val,0);

  const movM=DB.mov.filter(x=>x.m===CUR);
  const gnM=movM.filter(x=>x.tipo==="GN").reduce((a,b)=>a+b.val,0);
  const sdM=movM.filter(x=>x.tipo==="SD").reduce((a,b)=>a+b.val,0);

  $("kHoje").textContent=brl(gnT-sdT);
  $("kHoje2").textContent=`GN: ${brl(gnT)} ‚Ä¢ SD: ${brl(sdT)}`;
  $("kMes").textContent=brl(gnM-sdM);
  $("kMes2").textContent=`GN: ${brl(gnM)} ‚Ä¢ SD: ${brl(sdM)}`;

  // previs√£o offline simples (√∫ltimos 6 meses de GN)
  const months=[0,1,2,3,4,5].map(i=>{
    const d=new Date(); d.setMonth(d.getMonth()-i);
    const mm=d.toISOString().slice(0,7);
    const v=DB.mov.filter(x=>x.m===mm&&x.tipo==="GN").reduce((a,b)=>a+b.val,0);
    return {mm,v};
  }).reverse();
  const avg=months.reduce((a,b)=>a+b.v,0)/Math.max(1,months.length);
  const trend=(months.length>=2)?(months[months.length-1].v-months[0].v)/Math.max(1,months.length-1):0;
  $("prev").textContent=brl(Math.max(0,avg+trend));

  // top clientes
  const map={};
  movM.forEach(x=>{if(!x.cli)return; map[x.cli]=(map[x.cli]||0)+(x.tipo==="GN"?x.val:-x.val);});
  const top=Object.entries(map).sort((a,b)=>b[1]-a[1]).slice(0,3);
  $("topCli").textContent=top.length?top.map(([n,v])=>`${n} ‚Ä¢ ${brl(v)}`).join("  |  "):"Sem dados";

  animateChart(gnM,sdM);

  // hist√≥rico (mov)
  const L=$("movList"); L.innerHTML="";
  if(!movM.length){L.innerHTML=`<div class="small">Sem lan√ßamentos neste m√™s.</div>`;}
  else movM.slice(0,80).forEach(x=>{
    const sign=x.tipo==="GN"?"pos":"neg";
    const row=document.createElement("div");
    row.className="card"; row.style.marginTop="8px";
    row.innerHTML=`
      <div style="display:flex;justify-content:space-between;gap:10px;align-items:flex-start">
        <div style="min-width:0">
          <div style="font-weight:950">${x.cli||"Sem cliente"}</div>
          <div class="small">${x.obs||x.cat||"‚Äî"}</div>
        </div>
        <div style="text-align:right">
          <div class="${sign}" style="font-weight:950">${x.tipo} ${brl(x.val)}</div>
          <div class="small">${x.data}${x.cat?` ‚Ä¢ ${x.cat}`:""}</div>
        </div>
      </div>
      <div class="row" style="margin-top:10px">
        <button class="btn" style="background:transparent;color:var(--txt);border:1px solid var(--b)" onclick="copyText('${x.tipo} ${brl(x.val)} - ${x.data}')">Copiar</button>
        <button class="btn" style="background:transparent;color:var(--txt);border:1px solid var(--b)" onclick="delMov('${x.id}')">Remover</button>
      </div>`;
    L.appendChild(row);
  });

  // agenda
  const A=$("agList"); A.innerHTML="";
  const ag=DB.ag.slice().sort((a,b)=>(a.data+a.hora).localeCompare(b.data+b.hora));
  if(!ag.length) A.innerHTML=`<div class="small">Sem servi√ßos cadastrados.</div>`;
  else ag.forEach(s=>{
    const row=document.createElement("div"); row.className="card"; row.style.marginTop="8px";
    row.innerHTML=`
      <div style="font-weight:950">${s.cli} <span class="pill" style="margin-left:8px">${s.data} ${s.hora}</span></div>
      <div class="small" style="margin-top:6px">${s.desc}</div>
      <div class="row" style="margin-top:10px">
        <button class="btn" style="background:transparent;color:var(--txt);border:1px solid var(--b)" onclick="openZap('${s.tel||""}','*Serralheria do Gil*\\nServi√ßo: ${s.desc}\\nCliente: ${s.cli}\\nData: ${s.data} ${s.hora}')">Whats</button>
        <button class="btn" style="background:transparent;color:var(--txt);border:1px solid var(--b)" onclick="delAg('${s.id}')">Remover</button>
      </div>`;
    A.appendChild(row);
  });

  // clientes
  const C=$("cliList"); C.innerHTML="";
  if(!DB.cli.length) C.innerHTML=`<div class="small">Sem clientes ainda.</div>`;
  else DB.cli.forEach(c=>{
    const row=document.createElement("div"); row.className="card"; row.style.marginTop="8px";
    row.innerHTML=`
      <div style="font-weight:950">${c.nome}</div>
      <div class="small">${c.tel?c.tel:""} ${c.end?("‚Ä¢ "+c.end):""}</div>
      <div class="row" style="margin-top:10px">
        <button class="btn" style="background:transparent;color:var(--txt);border:1px solid var(--b)" onclick="delCli('${c.id}')">Remover</button>
      </div>`;
    C.appendChild(row);
  });

  // or√ßamentos
  const O=$("orcList"); O.innerHTML="";
  if(!DB.orc.length) O.innerHTML=`<div class="small">Sem or√ßamentos ainda.</div>`;
  else DB.orc.forEach(o=>{
    const row=document.createElement("div"); row.className="card"; row.style.marginTop="8px";
    row.innerHTML=`
      <div style="display:flex;justify-content:space-between;gap:10px;align-items:flex-start">
        <div style="min-width:0">
          <div style="font-weight:950">${o.cli}</div>
          <div class="small">${o.desc}${o.prazo?(" ‚Ä¢ Prazo: "+o.prazo):""}</div>
        </div>
        <div style="font-weight:950">${brl(o.val)}</div>
      </div>
      <div class="row" style="margin-top:10px">
        <button class="btn" style="background:transparent;color:var(--txt);border:1px solid var(--b)" onclick="openZap('${o.tel||""}', '*Or√ßamento - Serralheria do Gil*\\nCliente: ${o.cli}\\nServi√ßo: ${o.desc}\\nValor: ${brl(o.val)}\\nPrazo: ${o.prazo||"a combinar"}')">Whats</button>
        <button class="btn" style="background:transparent;color:var(--txt);border:1px solid var(--b)" onclick="delOrc('${o.id}')">Remover</button>
      </div>`;
    O.appendChild(row);
  });
}

/* ====== COPY ====== */
function copyText(txt){
  navigator.clipboard?.writeText(txt).then(()=>alert("Copiado ‚úÖ")).catch(()=>prompt("Copie:",txt));
}

/* ====== PARTICLES FX ====== */
const fx=$("fx"),ctx=fx.getContext("2d");
let P=[],last=0;

function fxResize(){
  const dpr=Math.max(1,devicePixelRatio||1);
  fx.width=Math.floor(innerWidth*dpr);
  fx.height=Math.floor(innerHeight*dpr);
}
function spawn(n=60){
  const dpr=Math.max(1,devicePixelRatio||1);
  P=[...Array(n)].map(()=>({
    x:Math.random()*fx.width,
    y:Math.random()*fx.height,
    r:(Math.random()*1.8+0.6)*dpr,
    v:(Math.random()*0.28+0.08)*dpr,
    a:Math.random()*0.35+0.1,
    c:Math.random()<.7?"76,255,136":"255,90,107"
  }));
}
function fxTick(t){
  const dt=Math.min(33,t-last||16); last=t;
  ctx.clearRect(0,0,fx.width,fx.height);
  P.forEach(p=>{
    p.y+=p.v*dt;
    if(p.y>fx.height+30){p.y=-30;p.x=Math.random()*fx.width;}
    ctx.fillStyle=`rgba(${p.c},${p.a})`;
    ctx.beginPath(); ctx.arc(p.x,p.y,p.r,0,Math.PI*2); ctx.fill();
  });
  requestAnimationFrame(fxTick);
}
window.addEventListener("resize",()=>{fxResize();spawn();render();});
</script>

</body></html>
