<!doctype html><html lang="pt-br"><head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>Serralheria do Gil</title><meta name="theme-color" content="#070b08">
<style>
:root{--bg:#070b08;--card:#0d1310cc;--b:#1c2a22;--t:#e9f2ea;--m:#9db0a3;--g:#51ff89;--r:#ff5a6b;--gl:0 18px 60px rgba(0,0,0,.55)}
*{box-sizing:border-box;-webkit-tap-highlight-color:transparent}html,body{height:100%}
body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--t);overflow-x:hidden}
.hidden{display:none!important}
#fx{position:fixed;inset:0;z-index:0;pointer-events:none;opacity:.9}
.wrap{position:relative;z-index:1;max-width:980px;margin:0 auto;padding:16px 14px 94px}
.top{display:flex;gap:12px;align-items:center;margin:4px 0 14px}
.badge{width:44px;height:44px;border-radius:14px;display:grid;place-items:center;font-weight:950;
background:linear-gradient(145deg,#0f1a13,#08100b);border:1px solid var(--b);box-shadow:var(--gl)}
.h1{font-size:28px;font-weight:950;margin:0;letter-spacing:.2px}
.sub{color:var(--m);font-size:13px;margin-top:2px}
.card{background:radial-gradient(140% 140% at 15% 10%,#142118cc 0%,#0b100dcc 45%,#070b08cc 100%);
border:1px solid var(--b);border-radius:18px;padding:14px;box-shadow:var(--gl);backdrop-filter:blur(10px)}
.row{display:flex;gap:10px;flex-wrap:wrap}
.kpi{flex:1;min-width:240px;position:relative;overflow:hidden}
.kpi:before{content:"";position:absolute;inset:-2px;opacity:.45;
background:radial-gradient(circle at 15% 15%,rgba(81,255,137,.18),transparent 45%),
radial-gradient(circle at 85% 35%,rgba(255,90,107,.14),transparent 50%)}
.kpi .t{color:var(--m);font-size:13px;position:relative}
.kpi .v{font-size:34px;font-weight:1000;margin-top:4px;position:relative}
.pill{padding:7px 10px;border-radius:999px;border:1px solid var(--b);background:#0b120eaa;color:var(--m);font-size:12px}
.btn{border:0;border-radius:14px;padding:12px 14px;font-weight:950;background:#fff;color:#070b08;cursor:pointer;transition:.15s}
.btn:active{transform:scale(.98)}
.ghost{background:transparent;color:var(--t);border:1px solid var(--b)}
.danger{background:linear-gradient(180deg,#351015,#240a0d);color:#ffd6dc;border:1px solid #4b1a21}
.in{width:100%;padding:12px;border-radius:14px;border:1px solid var(--b);background:#0b120eaa;color:var(--t);outline:none}
.in::placeholder{color:#6f8173}
.grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
@media(max-width:640px){.grid2{grid-template-columns:1fr}}
.small{color:var(--m);font-size:12px;line-height:1.35}
.pos{color:var(--g);font-weight:950}.neg{color:var(--r);font-weight:950}
.tab{display:none;animation:pop .18s ease both}.tab.on{display:block}
@keyframes pop{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
.nav{position:fixed;left:0;right:0;bottom:0;z-index:3;padding:10px 12px;
background:linear-gradient(180deg,transparent,rgba(0,0,0,.45) 18%,rgba(0,0,0,.88));backdrop-filter:blur(10px)}
.bar{max-width:980px;margin:0 auto;display:grid;grid-template-columns:repeat(5,1fr);gap:10px}
.nb{padding:10px 8px;border-radius:16px;border:1px solid var(--b);background:#0b120eaa;color:#b8c7bb;font-weight:950;
display:flex;gap:8px;align-items:center;justify-content:center;transition:.18s;user-select:none}
.nb i{font-style:normal;opacity:.9}
.nb.on{background:#fff;color:#070b08;border-color:#fff;box-shadow:0 10px 30px rgba(255,255,255,.10)}
.list .it{display:flex;gap:10px;align-items:center;justify-content:space-between;padding:10px 0;border-bottom:1px solid #162018}
.tag{font-size:12px;padding:4px 8px;border-radius:999px;border:1px solid var(--b);background:#0b120eaa;color:#cfe2d4}
canvas.chart{width:100%;height:220px;border-radius:18px;background:linear-gradient(180deg,#0a100c,#070b08);border:1px solid var(--b)}
/* anima√ß√£o ‚Äúmontando‚Äù */
.mount .card,.mount .nb{animation:in .32s cubic-bezier(.2,.8,.2,1) both}
@keyframes in{from{opacity:0;transform:translateY(18px) scale(.98)}to{opacity:1;transform:none}}
</style></head><body>
<canvas id="fx"></canvas>
<div class="wrap">
 <!-- HOME -->
<section id="home">
  <div class="card" style="max-width:440px;margin:18vh auto;text-align:center">
    <div style="font-size:32px;font-weight:1000">Serralheria do Gil</div>
    <div class="small" style="margin-top:8px">Gostaria de fazer dinheiro?<br>Clique no bot√£o abaixo.</div>
    <button class="btn" style="margin-top:18px" onclick="startApp()">Iniciar</button>
    <div class="small" style="margin-top:14px">Funciona offline e salva tudo no celular.</div>
  </div>
</section>

<!-- APP -->
<section id="app" class="hidden">
  <div class="top">
    <div class="badge">üîß</div>
    <div style="flex:1">
      <div class="h1">Serralheria do Gil</div>
      <div class="sub">Controle ‚Ä¢ Agenda ‚Ä¢ Or√ßamentos ‚Ä¢ Clientes ‚Ä¢ Materiais</div>
    </div>
    <button class="btn ghost" onclick="fechamento()">Fechamento</button>
  </div>

  <!-- DASH -->
  <section id="t0" class="tab on">
    <div class="row mount">
      <div class="card kpi">
        <div class="t">Saldo hoje</div><div class="v" id="kHoje">R$ 0,00</div>
        <div class="small" id="kHoje2">GN: R$ 0,00 ‚Ä¢ SD: R$ 0,00</div>
      </div>
      <div class="card kpi">
        <div class="t">Saldo do m√™s</div><div class="v" id="kMes">R$ 0,00</div>
        <div class="small" id="kMes2">GN: R$ 0,00 ‚Ä¢ SD: R$ 0,00 ‚Ä¢ Materiais: R$ 0,00</div>
      </div>
    </div>

    <div class="card mount" style="margin-top:10px">
      <div class="row" style="justify-content:space-between;align-items:center">
        <div>
          <div style="font-weight:1000">GN vs SD (m√™s)</div>
          <div class="small">Gr√°fico animado crescendo. Verde=GN, Vermelho=SD.</div>
        </div>
        <div class="pill" id="labMes">----</div>
      </div>
      <div style="margin-top:10px"><canvas id="chart" class="chart" width="900" height="300"></canvas></div>
      <div class="small" id="chartTip" style="margin-top:8px;min-height:16px"></div>
    </div>

    <div class="row mount" style="margin-top:10px">
      <div class="card kpi">
        <div class="t">Previs√£o (offline)</div><div class="v" id="prev">R$ 0,00</div>
        <div class="small">M√©dia m√≥vel + tend√™ncia simples.</div>
      </div>
      <div class="card kpi">
        <div class="t">Top clientes (m√™s)</div>
        <div class="v" style="font-size:16px;margin-top:10px" id="topCli">Sem dados</div>
        <div class="small">Ao lan√ßar GN/SD preencha ‚ÄúCliente‚Äù.</div>
      </div>
    </div>
  </section>

  <!-- MOV / AGENDA / CLIENTES / OR√á -->
  <section id="t1" class="tab"></section>
  <section id="t2" class="tab"></section>
  <section id="t3" class="tab"></section>
  <section id="t4" class="tab"></section>
</section>
</div>

<div class="nav"><div class="bar mount">
  <div class="nb on" id="n0" onclick="go('Dash')"><i>üìä</i>Dash</div>
  <div class="nb" id="n1" onclick="go('Mov')"><i>üí∞</i>Mov</div>
  <div class="nb" id="n2" onclick="go('Agenda')"><i>üìÖ</i>Agenda</div>
  <div class="nb" id="n3" onclick="go('Clientes')"><i>üë§</i>Clientes</div>
  <div class="nb" id="n4" onclick="go('Or√ß')"><i>üßæ</i>Or√ß</div>
</div></div>
<script>
 /* ===== DB ===== */
const K="gil_app_v1";
const $=id=>document.getElementById(id);
const J=(k,d)=>{try{return JSON.parse(localStorage.getItem(k)||"null")??d}catch{return d}};
const S=v=>localStorage.setItem(K,JSON.stringify(v));
const brl=n=>Number(n||0).toLocaleString("pt-BR",{style:"currency",currency:"BRL"});
const iso=()=>new Date().toISOString().slice(0,10);
const ym=d=>(d||new Date()).toISOString().slice(0,7);
const digits=s=>(s||"").replace(/\D/g,"");
const vib=()=>navigator.vibrate&&navigator.vibrate(12);

let DB=J(K,{tipo:"GN",mov:[],ag:[],cli:[],orc:[],mat:[],wa:""}), M=ym();

/* ===== START ===== */
function startApp(){
  $("home").classList.add("hidden");
  $("app").classList.remove("hidden");
  M=ym(); renderAll(); fxResize(); spawn(); requestAnimationFrame(fxTick);
  go("Dash");
}
function save(){S(DB)}
function setTipo(t){DB.tipo=t;save();renderMovBtns()}

/* ===== NAV ===== */
const tabs={Dash:0,Mov:1,Agenda:2,Clientes:3,"Or√ß":4};
function go(name){
  const i=tabs[name]; if(i==null) return;
  ["t0","t1","t2","t3","t4"].forEach((id,ix)=>$(id).className="tab"+(ix===i?" on":""));
  ["n0","n1","n2","n3","n4"].forEach(n=>$(n).classList.remove("on"));
  $("n"+i).classList.add("on");
  // anima√ß√£o ‚Äúmontando‚Äù
  document.querySelectorAll(".mount").forEach(x=>{x.style.animation="none";x.offsetHeight;x.style.animation=""});
  vib(); renderAll();
}

/* ===== FX particles ===== */
const fx=$("fx"),fxc=fx.getContext("2d");
let P=[],W=0,H=0,seed=0;
function fxResize(){W=fx.width=innerWidth*devicePixelRatio;H=fx.height=innerHeight*devicePixelRatio}
addEventListener("resize",fxResize,{passive:true});
function spawn(){
  P=[]; for(let i=0;i<70;i++)P.push({x:Math.random()*W,y:Math.random()*H,r:1+Math.random()*2.4,
  v:.2+Math.random()*1.2,a:.15+Math.random()*.35,h:Math.random()<.7?120:350});
}
function fxTick(){
  if(!W||!H) fxResize();
  fxc.clearRect(0,0,W,H);
  seed+=.002;
  // ‚Äúaurora‚Äù suave
  const g=fxc.createRadialGradient(W*.25,H*.15,0,W*.25,H*.15,W*.85);
  g.addColorStop(0,`rgba(80,255,140,.10)`); g.addColorStop(.6,"rgba(0,0,0,0)"); g.addColorStop(1,"rgba(0,0,0,0)");
  fxc.fillStyle=g; fxc.fillRect(0,0,W,H);
  P.forEach(p=>{
    p.y+=p.v*devicePixelRatio; p.x+=Math.sin(seed+p.y/500)*.15*devicePixelRatio;
    if(p.y>H+20) p.y=-20;
    fxc.beginPath(); fxc.fillStyle=`hsla(${p.h},90%,70%,${p.a})`;
    fxc.arc(p.x,p.y,p.r*devicePixelRatio,0,6.283); fxc.fill();
  });
  requestAnimationFrame(fxTick);
}
 /* ===== MOV (GN/SD) ===== */
function addMov(){
  const d=$("mData").value||iso(), v=+($("mVal").value||0);
  if(!v||v<=0) return alert("Valor inv√°lido");
  DB.mov.unshift({id:Date.now()+"",m:d.slice(0,7),data:d,tipo:DB.tipo,val:v,
    cli:($("mCli").value||"").trim(),cat:($("mCat").value||"").trim(),obs:($("mObs").value||"").trim()});
  save(); clearMov(); renderDash(); renderMovList();
}
function delMov(id){if(!confirm("Remover lan√ßamento?"))return; DB.mov=DB.mov.filter(x=>x.id!==id); save(); renderAll();}
function clearMov(){["mVal","mCli","mCat","mObs"].forEach(x=>$(x).value=""); $("mData").value=iso()}
function addQuick(n){$("mVal").value=+(($("mVal").value||0))+n; vib()}

function renderMovBtns(){
  const gn=$("bGN"),sd=$("bSD");
  if(!gn||!sd) return;
  gn.className="btn "+(DB.tipo==="GN"?"":"ghost");
  sd.className="btn "+(DB.tipo==="SD"?"":"ghost");
}
function renderMovList(){
  const box=$("movList"); if(!box) return;
  const items=DB.mov.filter(x=>x.m===M).slice(0,50);
  if(!items.length){box.innerHTML=`<div class="small">Sem lan√ßamentos neste m√™s.</div>`;return}
  box.innerHTML=items.map(x=>{
    const s=x.tipo==="GN"?`<span class="pos">GN</span>`:`<span class="neg">SD</span>`;
    const cli=x.cli?` <span class="tag">${esc(x.cli)}</span>`:"";
    const cat=x.cat?` <span class="tag">${esc(x.cat)}</span>`:"";
    return `<div class="it">
      <div style="min-width:0">
        <div style="font-weight:950">${s} ${brl(x.val)} <span class="small">‚Ä¢ ${x.data}</span></div>
        <div class="small" style="white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${cli}${cat} ${x.obs?esc(x.obs):""}</div>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <button class="btn ghost" onclick="copyMov('${x.id}')">Copiar</button>
        <button class="btn danger" onclick="delMov('${x.id}')">X</button>
      </div>
    </div>`;
  }).join("");
}
function copyMov(id){
  const x=DB.mov.find(a=>a.id===id); if(!x) return;
  const msg=`*${x.tipo}* ${brl(x.val)}\nData: ${x.data}\nCliente: ${x.cli||"-"}\nCat: ${x.cat||"-"}\nObs: ${x.obs||"-"}`;
  navigator.clipboard?.writeText(msg).catch(()=>{});
  alert("Copiado ‚úÖ"); vib();
}
function esc(s){return (s||"").replace(/[&<>"']/g,m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m]))}
 /* ===== AGENDA ===== */
function addAg(){
  const cli=($("aCli").value||"").trim(), desc=($("aDesc").value||"").trim();
  const data=$("aData").value||iso(), hora=$("aHora").value||"08:00";
  if(!cli||!desc) return alert("Cliente e descri√ß√£o obrigat√≥rios");
  DB.ag.unshift({id:Date.now()+"",cli,tel:digits($("aTel").value),data,hora,desc});
  save(); clearAg(); renderAgList(); checkAgendaNotifySoon();
}
function delAg(id){if(!confirm("Remover servi√ßo?"))return; DB.ag=DB.ag.filter(x=>x.id!==id); save(); renderAgList()}
function clearAg(){["aCli","aTel","aDesc"].forEach(x=>$(x).value=""); $("aData").value=iso(); $("aHora").value="08:00"}
async function askNoti(){
  if(!("Notification" in window)) return alert("Sem suporte a notifica√ß√£o.");
  const p=await Notification.requestPermission();
  alert(p==="granted"?"Notifica√ß√µes ativadas ‚úÖ":"Permiss√£o negada.");
}
function checkAgendaNotifySoon(){setTimeout(checkAgendaNotify,900)}
function checkAgendaNotify(){
  if(!("Notification" in window) || Notification.permission!=="granted") return;
  const now=Date.now();
  DB.ag.forEach(s=>{
    if(s._done) return;
    const dt=new Date(`${s.data}T${s.hora}:00`).getTime(), left=dt-now;
    if(left<=3600000 && left>0){
      s._done=1; save();
      new Notification("Serralheria do Gil",{body:`Servi√ßo: ${s.cli}\n${s.desc}\nFalta: ~${Math.ceil(left/60000)} min`});
    }
  });
}
function renderAgList(){
  const box=$("agList"); if(!box) return;
  const items=[...DB.ag].sort((a,b)=>`${a.data} ${a.hora}`.localeCompare(`${b.data} ${b.hora}`)).slice(0,80);
  box.innerHTML=items.length?items.map(s=>`<div class="it">
    <div style="min-width:0">
      <div style="font-weight:950">${esc(s.cli)} <span class="small">‚Ä¢ ${s.data} ${s.hora}</span></div>
      <div class="small" style="white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${esc(s.desc)}</div>
    </div>
    <div style="display:flex;gap:8px">
      <button class="btn ghost" onclick="zapServico('${s.id}')">Zap</button>
      <button class="btn danger" onclick="delAg('${s.id}')">X</button>
    </div>
  </div>`).join(""):`<div class="small">Sem servi√ßos na agenda.</div>`;
}

/* ===== CLIENTES ===== */
function addCli(){
  const nome=($("cNome").value||"").trim(); if(!nome) return alert("Nome obrigat√≥rio");
  const tel=digits($("cTel").value), end=($("cEnd").value||"").trim();
  const ex=DB.cli.find(c=>c.nome.toLowerCase()===nome.toLowerCase());
  if(ex){ex.tel=tel; ex.end=end;} else DB.cli.unshift({id:Date.now()+"",nome,tel,end});
  save(); clearCli(); renderCliList();
}
function delCli(id){if(!confirm("Remover cliente?"))return; DB.cli=DB.cli.filter(x=>x.id!==id); save(); renderCliList()}
function clearCli(){["cNome","cTel","cEnd"].forEach(x=>$(x).value="")}
function renderCliList(){
  const box=$("cliList"); if(!box) return;
  box.innerHTML=DB.cli.length?DB.cli.map(c=>`<div class="it">
    <div style="min-width:0">
      <div style="font-weight:950">${esc(c.nome)} ${c.tel?`<span class="tag">${fmtTel(c.tel)}</span>`:""}</div>
      <div class="small" style="white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${c.end?esc(c.end):"‚Äî"}</div>
    </div>
    <div style="display:flex;gap:8px">
      <button class="btn ghost" onclick="zapCli('${c.id}')">Zap</button>
      <button class="btn danger" onclick="delCli('${c.id}')">X</button>
    </div>
  </div>`).join(""):`<div class="small">Nenhum cliente cadastrado.</div>`;
}
function fmtTel(t){t=digits(t); if(t.length<10) return t; return `(${t.slice(0,2)}) ${t.slice(2,7)}-${t.slice(7)}`;}
 /* ===== HTML das abas (injeta pra evitar sumir coisa) ===== */
function buildTabs(){
  $("t1").innerHTML=`
  <div class="card mount">
    <div class="grid2">
      <div>
        <div class="small">Tipo</div>
        <div class="row">
          <button class="btn ghost" id="bGN" onclick="setTipo('GN')">GN (Ganhos)</button>
          <button class="btn ghost" id="bSD" onclick="setTipo('SD')">SD (Sa√≠das)</button>
        </div>
      </div>
      <div><div class="small">Data</div><input class="in" id="mData" type="date"></div>
    </div>
    <div class="grid2" style="margin-top:10px">
      <div><div class="small">Valor (R$)</div><input class="in" id="mVal" type="number" step="0.01" placeholder="Ex: 250"></div>
      <div><div class="small">Cliente (opcional)</div><input class="in" id="mCli" placeholder="Ex: Jo√£o / Construtora X"></div>
    </div>
    <div class="grid2" style="margin-top:10px">
      <div><div class="small">Categoria (opcional)</div><input class="in" id="mCat" placeholder="Ex: Port√£o / Solda / Combust√≠vel"></div>
      <div><div class="small">Obs (opcional)</div><input class="in" id="mObs" placeholder="Ex: sinal, restante, etc"></div>
    </div>
    <div class="row" style="margin-top:10px">
      <button class="btn" onclick="addMov()">Salvar</button>
      <button class="btn ghost" onclick="clearMov()">Limpar</button>
      <button class="btn ghost" onclick="go('Dash')">Ver Dash</button>
    </div>
    <div class="small" style="margin-top:10px">Atalhos:</div>
    <div class="row">
      <button class="btn ghost" onclick="addQuick(50)">+50</button>
      <button class="btn ghost" onclick="addQuick(100)">+100</button>
      <button class="btn ghost" onclick="addQuick(200)">+200</button>
      <button class="btn ghost" onclick="addQuick(500)">+500</button>
    </div>
  </div>
  <div class="card mount" style="margin-top:10px">
    <div style="font-weight:1000">Hist√≥rico do m√™s</div>
    <div class="small">Tem copiar e remover.</div>
    <div class="list" id="movList"></div>
  </div>`;

  $("t2").innerHTML=`
  <div class="card mount">
    <div class="grid2">
      <div><div class="small">Cliente</div><input class="in" id="aCli" placeholder="Nome do cliente"></div>
      <div><div class="small">Telefone (opcional)</div><input class="in" id="aTel" inputmode="tel" placeholder="(41) 9...."></div>
    </div>
    <div class="grid2" style="margin-top:10px">
      <div><div class="small">Data</div><input class="in" id="aData" type="date"></div>
      <div><div class="small">Hora</div><input class="in" id="aHora" type="time"></div>
    </div>
    <div style="margin-top:10px"><div class="small">Descri√ß√£o</div><input class="in" id="aDesc" placeholder="Ex: Instalar port√£o, ajuste, solda..."></div>
    <div class="row" style="margin-top:10px">
      <button class="btn" onclick="addAg()">Salvar</button>
      <button class="btn ghost" onclick="clearAg()">Limpar</button>
      <button class="btn ghost" onclick="askNoti()">Notifica√ß√£o</button>
    </div>
    <div class="small" style="margin-top:8px">Lembrete 1h antes funciona com o app aberto (limite do navegador).</div>
  </div>
  <div class="card mount" style="margin-top:10px">
    <div style="font-weight:1000">Pr√≥ximos servi√ßos</div>
    <div class="list" id="agList"></div>
  </div>`;

  $("t3").innerHTML=`
  <div class="card mount">
    <div class="grid2">
      <div><div class="small">Nome</div><input class="in" id="cNome" placeholder="Cliente"></div>
      <div><div class="small">Telefone</div><input class="in" id="cTel" inputmode="tel" placeholder="(41) 9...."></div>
    </div>
    <div style="margin-top:10px"><div class="small">Endere√ßo</div><input class="in" id="cEnd" placeholder="Rua, bairro..."></div>
    <div class="row" style="margin-top:10px">
      <button class="btn" onclick="addCli()">Salvar</button>
      <button class="btn ghost" onclick="clearCli()">Limpar</button>
    </div>
  </div>
  <div class="card mount" style="margin-top:10px">
    <div style="font-weight:1000">Lista de clientes</div>
    <div class="list" id="cliList"></div>
  </div>`;

  $("t4").innerHTML=`
  <div class="card mount">
    <div class="grid2">
      <div><div class="small">Cliente</div><input class="in" id="oCli" placeholder="Nome do cliente"></div>
      <div><div class="small">Telefone (opcional)</div><input class="in" id="oTel" inputmode="tel" placeholder="(41) 9...."></div>
    </div>
    <div class="grid2" style="margin-top:10px">
      <div><div class="small">Pre√ßo (R$)</div><input class="in" id="oVal" type="number" step="0.01" placeholder="Ex: 1200"></div>
      <div><div class="small">Prazo</div><input class="in" id="oPrazo" placeholder="Ex: 3 dias / 1 semana"></div>
    </div>
    <div style="margin-top:10px"><div class="small">Descri√ß√£o</div><input class="in" id="oDesc" placeholder="Ex: Port√£o + pintura..."></div>
    <div class="row" style="margin-top:10px">
      <button class="btn" onclick="addOrc()">Salvar</button>
      <button class="btn ghost" onclick="clearOrc()">Limpar</button>
      <button class="btn ghost" onclick="zapOrc()">Enviar no WhatsApp</button>
    </div>
    <div class="small" style="margin-top:8px">O WhatsApp abre com a mensagem pronta.</div>
  </div>
  <div class="card mount" style="margin-top:10px">
    <div style="font-weight:1000">Or√ßamentos</div>
    <div class="list" id="orcList"></div>
  </div>`;
}

function openZap(tel,msg){
  tel=digits(tel||"");
  const u = tel?`https://wa.me/${tel}?text=${encodeURIComponent(msg)}`:`https://wa.me/?text=${encodeURIComponent(msg)}`;
  window.open(u,"_blank");
}
 /* ===== OR√áAMENTOS ===== */
function addOrc(){
  const cli=($("oCli").value||"").trim(), val=+($("oVal").value||0), desc=($("oDesc").value||"").trim();
  if(!cli||!val||val<=0||!desc) return alert("Preencha Cliente, Valor e Descri√ß√£o.");
  DB.orc.unshift({id:Date.now()+"",cli,tel:digits($("oTel").value),val,prazo:($("oPrazo").value||"").trim(),desc,at:Date.now()});
  save(); clearOrc(); renderOrcList(); vib();
}
function clearOrc(){["oCli","oTel","oVal","oPrazo","oDesc"].forEach(x=>$(x).value="")}
function delOrc(id){if(!confirm("Remover or√ßamento?"))return; DB.orc=DB.orc.filter(x=>x.id!==id); save(); renderOrcList();}

function zapOrc(){
  const cli=($("oCli").value||"").trim(), val=+($("oVal").value||0), prazo=($("oPrazo").value||"").trim(), desc=($("oDesc").value||"").trim();
  if(!cli||!val||val<=0||!desc) return alert("Preencha cliente, valor e descri√ß√£o antes.");
  const tel=digits($("oTel").value)||DB.wa||"";
  const msg=`*Or√ßamento - Serralheria do Gil*\nCliente: ${cli}\nServi√ßo: ${desc}\nValor: ${brl(val)}\nPrazo: ${prazo||"a combinar"}\n\nSe aprovar, me confirma por aqui.`;
  openZap(tel,msg);
}
function renderOrcList(){
  const box=$("orcList"); if(!box) return;
  if(!DB.orc.length){box.innerHTML=`<div class="small">Sem or√ßamentos.</div>`;return}
  box.innerHTML=DB.orc.slice(0,60).map(o=>`<div class="it">
    <div style="min-width:0">
      <div style="font-weight:950">${esc(o.cli)} <span class="small">‚Ä¢ ${brl(o.val)}</span></div>
      <div class="small" style="white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${esc(o.desc)} ${o.prazo?`‚Ä¢ ${esc(o.prazo)}`:""}</div>
    </div>
    <div style="display:flex;gap:8px">
      <button class="btn ghost" onclick="openZap('${o.tel||DB.wa||""}',${JSON.stringify("")}.concat('*Or√ßamento - Serralheria do Gil*\\nCliente: ${o.cli}\\nServi√ßo: ${o.desc}\\nValor: ${brl(o.val)}\\nPrazo: ${o.prazo||"a combinar"}\\n'))">Zap</button>
      <button class="btn danger" onclick="delOrc('${o.id}')">X</button>
    </div>
  </div>`).join("");
}

/* ===== Zap r√°pido (cliente/servi√ßo) ===== */
function zapCli(id){
  const c=DB.cli.find(x=>x.id===id); if(!c) return;
  const tel=c.tel||DB.wa||"";
  const msg=`Ol√° ${c.nome}! Aqui √© da *Serralheria do Gil*.\n`;
  openZap(tel,msg);
}
function zapServico(id){
  const s=DB.ag.find(x=>x.id===id); if(!s) return;
  const tel=s.tel||DB.wa||"";
  const msg=`*Serralheria do Gil* ‚úÖ\nServi√ßo: ${s.cli}\n${s.desc}\nData: ${s.data} ${s.hora}`;
  openZap(tel,msg);
}
 /* ===== DASH (c√°lculos) ===== */
function sumMov(rangeYM){
  let gn=0,sd=0;
  DB.mov.forEach(x=>{
    if(rangeYM && x.m!==rangeYM) return;
    if(x.tipo==="GN") gn+=x.val; else sd+=x.val;
  });
  return {gn,sd,net:gn-sd};
}
function topClientesMes(){
  const map=new Map();
  DB.mov.forEach(x=>{
    if(x.m!==M || !x.cli) return;
    const k=x.cli.trim(); if(!k) return;
    map.set(k,(map.get(k)||0)+(x.tipo==="GN"?x.val:-x.val));
  });
  const arr=[...map.entries()].sort((a,b)=>b[1]-a[1]).slice(0,3);
  if(!arr.length) return "Sem dados";
  return arr.map(([n,v])=>`${n} ‚Ä¢ ${brl(v)}`).join("<br>");
}
function previsaoNext(){
  // m√©dia m√≥vel dos √∫ltimos 3 meses + tend√™ncia simples
  const months=[...new Set(DB.mov.map(x=>x.m))].sort().slice(-4);
  const totals=months.map(m=>sumMov(m).gn);
  if(!totals.length) return 0;
  const avg = totals.slice(-3).reduce((a,b)=>a+b,0)/Math.min(3,totals.length);
  const trend = totals.length>=2 ? (totals[totals.length-1]-totals[totals.length-2]) : 0;
  return Math.max(0, avg + trend*0.6);
}
function renderDash(){
  const today=iso(), y=M;
  const td=DB.mov.filter(x=>x.data===today);
  const gnH=td.filter(x=>x.tipo==="GN").reduce((a,b)=>a+b.val,0);
  const sdH=td.filter(x=>x.tipo==="SD").reduce((a,b)=>a+b.val,0);
  $("kHoje").textContent=brl(gnH-sdH);
  $("kHoje2").textContent=`GN: ${brl(gnH)} ‚Ä¢ SD: ${brl(sdH)}`;

  const {gn,sd,net}=sumMov(y);
  $("kMes").textContent=brl(net);
  $("kMes2").textContent=`GN: ${brl(gn)} ‚Ä¢ SD: ${brl(sd)} ‚Ä¢ Materiais: ${brl(0)}`;
  $("labMes").textContent=y;
  $("topCli").innerHTML=topClientesMes();
  $("prev").textContent=brl(previsaoNext());

  drawChart(); // gr√°fico animado
}
function renderAll(){
  if(!$("app")||$("app").classList.contains("hidden")) return;
  if(!$("t1").innerHTML) buildTabs();
  // defaults
  if($("mData")) $("mData").value=iso();
  if($("aData")) $("aData").value=iso();
  renderMovBtns();
  renderDash();
  renderMovList();
  renderAgList();
  renderCliList();
  renderOrcList();
}
 /* ===== CHART (canvas animado) ===== */
let anim=0, lastKey="";
function monthDays(ymStr){
  const [Y,Mm]=ymStr.split("-").map(Number);
  return new Date(Y,Mm,0).getDate();
}
function byDay(){
  const days=monthDays(M);
  const gn=Array(days).fill(0), sd=Array(days).fill(0);
  DB.mov.forEach(x=>{
    if(x.m!==M) return;
    const d=+x.data.slice(8,10)-1;
    if(d<0||d>=days) return;
    (x.tipo==="GN"?gn:sd)[d]+=x.val;
  });
  return {gn,sd};
}
function drawChart(){
  const c=$("chart"); if(!c) return;
  const ctx=c.getContext("2d");
  const key=M+"|"+DB.mov.length;
  if(key!==lastKey){anim=0; lastKey=key;}
  anim=Math.min(1,anim+.06);

  const {gn,sd}=byDay();
  const w=c.width,h=c.height, pad=26, base=h-pad;
  ctx.clearRect(0,0,w,h);

  // grid
  ctx.globalAlpha=.25; ctx.strokeStyle="#223028";
  for(let i=0;i<4;i++){
    const y=pad+(i*(h-pad*2)/3);
    ctx.beginPath(); ctx.moveTo(pad,y); ctx.lineTo(w-pad,y); ctx.stroke();
  }
  ctx.globalAlpha=1;

  const max=Math.max(1,...gn.map((v,i)=>v+sd[i]));
  const days=gn.length;
  const bw=(w-pad*2)/days;

  // barras GN/SD (stack) com anima√ß√£o
  for(let i=0;i<days;i++){
    const x=pad+i*bw+bw*.12, ww=bw*.76;
    const gH=(gn[i]/max)*(h-pad*2)*anim;
    const sH=(sd[i]/max)*(h-pad*2)*anim;

    // SD base (vermelho)
    ctx.fillStyle="rgba(255,90,107,.80)";
    ctx.beginPath();
    roundRect(ctx,x,base-sH,ww,sH,10); ctx.fill();

    // GN em cima (verde)
    ctx.fillStyle="rgba(81,255,137,.85)";
    ctx.beginPath();
    roundRect(ctx,x,base-sH-gH,ww,gH,10); ctx.fill();
  }

  // legenda / tip
  const ms=sumMov(M);
  $("chartTip").innerHTML=`<span class="pos">GN</span> ${brl(ms.gn)} &nbsp; <span class="neg">SD</span> ${brl(ms.sd)} &nbsp; Total: ${brl(ms.net)}`;
}
function roundRect(ctx,x,y,w,h,r){
  r=Math.min(r,w/2,h/2);
  ctx.moveTo(x+r,y);
  ctx.arcTo(x+w,y,x+w,y+h,r);
  ctx.arcTo(x+w,y+h,x,y+h,r);
  ctx.arcTo(x,y+h,x,y,r);
  ctx.arcTo(x,y,x+w,y,r);
              }
 /* ===== FECHAMENTO / CONFIG ===== */
function fechamento(){
  const ms=sumMov(M);
  const wa=prompt(
`FECHAMENTO (${M})
GN: ${brl(ms.gn)}
SD: ${brl(ms.sd)}
L√≠quido: ${brl(ms.net)}

WhatsApp padr√£o (somente n√∫meros, ex: 55419xxxxxxx):
(deixe vazio pra n√£o salvar)`, DB.wa||""
  );
  if(wa!=null){
    DB.wa=digits(wa)||DB.wa||"";
    save(); alert("Config salva ‚úÖ"); vib();
  }
}

/* ===== start hooks ===== */
(function boot(){
  fxResize(); spawn(); requestAnimationFrame(fxTick);
  // se quiser iniciar direto sem home, descomenta:
  // startApp();
})();

/* garante render ao voltar pro app */
document.addEventListener("visibilitychange",()=>{ if(!document.hidden) renderAll(); });

</script></body></html>
